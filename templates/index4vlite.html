<!DOCTYPE html>
<html lang="vi" class="dark">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>B·∫£ng ƒêi·ªÅu Khi·ªÉn H·ªá Th·ªëng Ph√¢n Lo·∫°i (LITE)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* CSS Gi·ªØ Nguy√™n t·ª´ b·∫£n Lite tr∆∞·ªõc */
        body {
            font-family: Inter, sans-serif;
        }

        .sensor-light {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            transition: background-color 0.3s;
        }

        .sensor-active {
            background-color: #f59e0b;
        }

        .sensor-inactive {
            background-color: #4b5563;
        }

        .relay-light {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            transition: background-color 0.3s;
        }

        .relay-active {
            background-color: #22c55e;
        }

        .relay-inactive {
            background-color: #ef4444;
        }

        #qr-overlay {
            position: absolute;
            top: 1rem;
            right: 1rem;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 1.25rem;
            font-weight: bold;
            color: white;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            z-index: 10;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        /* CSS cho Timeline Queue ƒê·ªông */
        .queue-timeline {
            display: flex;
            gap: 0.5rem;
            overflow-x: auto;
            padding: 0.5rem 0;
            scroll-behavior: smooth;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .queue-timeline::-webkit-scrollbar {
            display: none;
        }

        .queue-item {
            min-width: 80px;
            text-align: center;
            font-weight: bold;
            color: white;
            border-radius: 8px;
            padding: 0.25rem 0.5rem;
            transition: transform 0.4s ease, opacity 0.4s ease, min-width 0.4s ease;
            white-space: nowrap;
        }
        /* Hi·ªáu ·ª©ng v√†o/ra (ph·ª•c h·ªìi animation) */
        .queue-item.enter { 
            transform: translateY(-10px); 
            opacity: 0; 
            min-width: 0;
            padding-left: 0;
            padding-right: 0;
        }
        .queue-item.show { 
            transform: translateY(0); 
            opacity: 1; 
            min-width: 80px;
        }
        .queue-item.exit { 
            transform: translateY(10px); 
            opacity: 0; 
            min-width: 0;
            padding-left: 0;
            padding-right: 0;
        }

        .queue-count-bar {
            transition: width 0.5s ease, background-color 0.5s ease;
        }
    </style>
</head>

<body class="bg-gray-900 text-gray-200 p-4">
    <!-- Banner B·∫£o tr√¨ (Gi·ªØ l·∫°i ƒë·ªÉ ng∆∞·ªùi d√πng bi·∫øt h·ªá th·ªëng b·ªã d·ª´ng) -->
    <div id="maintenance-banner"
        class="hidden fixed top-0 left-0 w-full bg-red-700 text-white p-3 text-center z-50 shadow-lg">
        <div class="flex items-center justify-center">
            <span class="text-lg font-bold">‚ö†Ô∏è H·ªÜ TH·ªêNG ƒêANG B·∫¢O TR√å: <span id="maintenance-error"
                    class="font-normal">...</span></span>
            <!-- N√∫t reset ƒë∆°n gi·∫£n -->
            <button onclick="resetMaintenance()"
                class="ml-4 bg-amber-300 text-red-900 font-bold py-1 px-3 rounded-md text-sm hover:bg-amber-200">
                Tho√°t B·∫£o Tr√¨
            </button>
        </div>
    </div>

    <h1 class="text-2xl font-bold text-center mb-4 text-white mt-8">
        ‚öôÔ∏è B·∫£ng ƒêi·ªÅu Khi·ªÉn H·ªá Th·ªëng Ph√¢n Lo·∫°i (LITE)
    </h1>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <!-- C·ªôt tr√°i: H√†ng ch·ªù, Camera, Log, C·∫•u h√¨nh -->
        <div class="lg:col-span-2 flex flex-col space-y-4">
            <!-- H√†ng ch·ªù -->
            <div class="bg-gray-800 p-3 rounded-lg shadow-lg">
                <h2 class="text-lg font-semibold mb-2 text-white">üì¶ H√†ng Ch·ªù QR</h2>
                <div id="queue-timeline-container" class="bg-gray-900 rounded-md p-2 min-h-[4rem]">
                    <div id="queue-timeline" class="queue-timeline">
                        <span id="qr-queue-empty" class="text-gray-500 text-sm">H√†ng ch·ªù ƒëang r·ªóng...</span>
                    </div>
                </div>

                <!-- Thanh t·ªïng s·ªë v·∫≠t -->
                <div class="mt-3">
                    <div class="flex justify-between text-xs text-gray-400">
                        <span>T·ªïng s·ªë v·∫≠t ƒëang ch·ªù:</span>
                        <span id="queue-count-text">0 / 5</span>
                    </div>
                    <div class="w-full bg-gray-700 h-3 rounded-full mt-1">
                        <div id="queue-count-bar" class="h-3 bg-green-500 rounded-full queue-count-bar" style="width: 0%;"></div>
                    </div>
                </div>

                <button onclick="resetQueue()"
                    class="mt-3 w-full bg-red-700 hover:bg-red-600 text-white py-1.5 px-2 rounded text-sm font-medium">
                    üßπ Reset H√†ng Ch·ªù
                </button>
            </div>

            <!-- Camera -->
            <div class="bg-gray-800 p-3 rounded-lg shadow-lg relative">
                <h2 class="text-lg font-semibold mb-2 text-white">üì∑ Camera Gi√°m S√°t</h2>
                <div class="bg-black rounded-md overflow-hidden aspect-video relative">
                    <img id="video_feed" src="/video_feed" class="w-full h-full object-cover" />
                    <div id="qr-overlay"></div>
                </div>
            </div>

            <!-- Log -->
            <div class="bg-gray-800 p-3 rounded-lg shadow-lg">
                <h2 class="text-lg font-semibold mb-2 text-white">üßæ Logs H·ªá Th·ªëng</h2>
                <div id="log-container"
                    class="h-64 bg-gray-900 rounded-md p-2 overflow-y-auto text-xs font-mono space-y-1"></div>
            </div>

            <!-- KH·ªêI C·∫§U H√åNH TR·ª∞C TI·∫æP (ƒê·∫∂T ·ªû CU·ªêI C·ªòT TR√ÅI) -->
            <div id="page-config-lite" class="bg-gray-800 p-4 rounded-lg shadow-lg">
                <h2 class="text-xl font-semibold text-white mb-4">‚öôÔ∏è C·∫•u H√¨nh `config.json` (Ch·ªânh s·ª≠a tr·ª±c ti·∫øp)</h2>
                
                <p class="text-sm text-yellow-400 mb-3">‚ö†Ô∏è Sau khi ch·ªânh s·ª≠a, nh·∫•n L∆∞u v√† kh·ªüi ƒë·ªông l·∫°i Server Python ƒë·ªÉ c√°c thay ƒë·ªïi v·ªÅ ch√¢n GPIO ho·∫∑c Lanes c√≥ hi·ªáu l·ª±c.</p>

                <div class="mb-4">
                    <textarea id="config-json-editor" 
                        class="w-full bg-gray-900 text-green-400 text-xs p-3 rounded-md border border-gray-700 font-mono resize-y"
                        rows="15" placeholder="ƒêang t·∫£i config..."></textarea>
                </div>

                <div class="flex space-x-3">
                    <button onclick="saveConfig()"
                        class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-md">üíæ L∆∞u & C·∫≠p Nh·∫≠t Config</button>
                    <button onclick="loadConfig()"
                        class="flex-1 bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg shadow-md">üîÑ T·∫£i L·∫°i Config</button>
                </div>
            </div>
            <!-- (K·∫æT TH√öC) KH·ªêI C·∫§U H√åNH TR·ª∞C TI·∫æP -->

        </div>

        <!-- C·ªôt ph·∫£i: Lanes -->
        <div class="lg:col-span-1 space-y-3">
            <div class="bg-gray-800 p-3 rounded-lg shadow-lg">
                <h2 class="text-lg font-semibold mb-3 text-white">üìä Tr·∫°ng Th√°i Lanes</h2>

                <div id="lanes" class="space-y-3">
                    <!-- Lane Template -->
                    <div id="lane-0" class="border border-gray-700 p-3 rounded-md">
                        <div class="flex justify-between items-center mb-1">
                            <span id="lane-0-name" class="font-bold">Lo·∫°i 1</span>
                            <span id="status-text-0"
                                class="text-xs px-2 py-1 rounded-full bg-gray-700 transition-all">S·∫µn s√†ng</span>
                        </div>
                        <div class="flex justify-between text-sm mb-1">
                            <span>ƒê√£ ƒë·∫øm:</span>
                            <span id="lane-0-count" class="font-bold text-lg">0</span>
                        </div>
                        <div class="flex justify-between text-xs">
                            <span>Sensor:</span>
                            <div id="lane-0-sensor" class="sensor-light sensor-inactive"></div>
                        </div>
                        <div class="flex justify-between text-xs mt-1">
                            <span>Relay Thu:</span>
                            <div id="lane-0-grab" class="relay-light relay-inactive"></div>
                        </div>
                        <div class="flex justify-between text-xs mt-1">
                            <span>Relay ƒê·∫©y:</span>
                            <div id="lane-0-push" class="relay-light relay-inactive"></div>
                        </div>
                    </div>

                    <div id="lane-1" class="border border-gray-700 p-3 rounded-md">
                        <div class="flex justify-between items-center mb-1">
                            <span id="lane-1-name" class="font-bold">Lo·∫°i 2</span>
                            <span id="status-text-1"
                                class="text-xs px-2 py-1 rounded-full bg-gray-700 transition-all">S·∫µn s√†ng</span>
                        </div>
                        <div class="flex justify-between text-sm mb-1">
                            <span>ƒê√£ ƒë·∫øm:</span>
                            <span id="lane-1-count" class="font-bold text-lg">0</span>
                        </div>
                        <div class="flex justify-between text-xs">
                            <span>Sensor:</span>
                            <div id="lane-1-sensor" class="sensor-light sensor-inactive"></div>
                        </div>
                        <div class="flex justify-between text-xs mt-1">
                            <span>Relay Thu:</span>
                            <div id="lane-1-grab" class="relay-light relay-inactive"></div>
                        </div>
                        <div class="flex justify-between text-xs mt-1">
                            <span>Relay ƒê·∫©y:</span>
                            <div id="lane-1-push" class="relay-light relay-inactive"></div>
                        </div>
                    </div>

                    <div id="lane-2" class="border border-gray-700 p-3 rounded-md">
                        <div class="flex justify-between items-center mb-1">
                            <span id="lane-2-name" class="font-bold">Lo·∫°i 3</span>
                            <span id="status-text-2"
                                class="text-xs px-2 py-1 rounded-full bg-gray-700 transition-all">S·∫µn s√†ng</span>
                        </div>
                        <div class="flex justify-between text-sm mb-1">
                            <span>ƒê√£ ƒë·∫øm:</span>
                            <span id="lane-2-count" class="font-bold text-lg">0</span>
                        </div>
                        <div class="flex justify-between text-xs">
                            <span>Sensor:</span>
                            <div id="lane-2-sensor" class="sensor-light sensor-inactive"></div>
                        </div>
                        <div class="flex justify-between text-xs mt-1">
                            <span>Relay Thu:</span>
                            <div id="lane-2-grab" class="relay-light relay-inactive"></div>
                        </div>
                        <div class="flex justify-between text-xs mt-1">
                            <span>Relay ƒê·∫©y:</span>
                            <div id="lane-2-push" class="relay-light relay-inactive"></div>
                        </div>
                    </div>
                </div>
                
                <button onclick="resetCount('all')"
                    class="mt-3 w-full bg-red-600 hover:bg-red-700 text-white py-1.5 px-2 rounded text-sm font-medium">
                    Reset To√†n B·ªô ƒê·∫øm
                </button>
            </div>
        </div>
    </div>

    <script>
        let ws;
        const MAX_QUEUE = 5;
        const laneNamesMap = {};
        window._prevQueue = [];

        document.addEventListener("DOMContentLoaded", () => {
            document.getElementById("video_feed").src = "/video_feed";
            connectWS();
            loadConfig(); // T·∫£i config khi load trang
        });

        // --- X·ª≠ l√Ω WebSocket ---
        function connectWS() {
            const url = `${location.protocol === "https:" ? "wss:" : "ws:"}//${location.host}/ws`;
            ws = new WebSocket(url);
            ws.onmessage = e => {
                const d = JSON.parse(e.data);
                if (d.type === "state_update") updateState(d.state);
                else if (d.type === "log") addLog(d.log_type, d.message, d.timestamp, d.data);
            };
            ws.onclose = () => {
                addLog("error", "M·∫•t k·∫øt n·ªëi WebSocket. ƒêang th·ª≠ k·∫øt n·ªëi l·∫°i sau 3s...");
                setTimeout(connectWS, 3000);
            };
        }

        // --- X·ª≠ l√Ω Log ---
        function addLog(type, msg, time, data) {
            const log = document.getElementById("log-container");
            const t = time || new Date().toLocaleTimeString();
            let prefix = "";
            let colorClass = "text-gray-400";
            
            switch (type) {
                case "success": colorClass = "text-green-400"; prefix = "[OK]"; break;
                case "error": colorClass = "text-red-400"; prefix = "[L·ªñI]"; break;
                case "warn": colorClass = "text-yellow-400"; prefix = "[WARN]"; break;
                case "sort": colorClass = "text-cyan-400"; prefix = "[SORT]"; msg = `Ph√¢n lo·∫°i ${data.name}, t·ªïng: ${data.count}`; showQrOverlay(data.name, 'bg-cyan-600'); break;
                case "qr": colorClass = "text-blue-400"; prefix = "[QR]"; msg = `Ph√°t hi·ªán ${data}`; showQrOverlay(data, 'bg-blue-600'); break;
                default: prefix = `[INFO]`;
            }
            
            const entry = document.createElement("div");
            entry.className = `flex ${colorClass}`;
            entry.innerHTML = `<span class='w-20 flex-shrink-0'>[${t}]</span><span class='w-16 flex-shrink-0'>${prefix}</span><span class='flex-1'>${msg}</span>`;
            
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;

            if (data?.queue) updateQueueUI(data.queue);

            // X·ª≠ l√Ω Maintenance banner
            if (type === "error" && msg.includes("MAINTENANCE MODE")) {
                document.getElementById('maintenance-error').textContent = msg.replace("MAINTENANCE MODE: ", "");
                document.getElementById('maintenance-banner').classList.remove('hidden');
            } else if (type === "success" && msg.includes("Ch·∫ø ƒë·ªô b·∫£o tr√¨ ƒë√£ ƒë∆∞·ª£c reset")) {
                document.getElementById('maintenance-banner').classList.add('hidden');
            }
        }

        // --- X·ª≠ l√Ω Queue UI ƒë·ªông ---
        function updateQueueUI(q) {
            const box = document.getElementById("queue-timeline");
            const empty = document.getElementById("qr-queue-empty");
            
            const oldItems = Array.from(box.querySelectorAll('.queue-item'));
            const newQueue = q.slice();
            const oldQueue = window._prevQueue || [];
            window._prevQueue = newQueue;

            // 1. C·∫≠p nh·∫≠t thanh t·ªïng s·ªë v·∫≠t ƒëang ch·ªù
            const count = q.length;
            const percent = Math.min((count / MAX_QUEUE) * 100, 100);
            const bar = document.getElementById("queue-count-bar");
            const text = document.getElementById("queue-count-text");
            
            bar.style.width = `${percent}%`;
            bar.className = `h-3 rounded-full queue-count-bar ${
                percent > 80 ? 'bg-red-600' : percent > 50 ? 'bg-yellow-500' : 'bg-green-500'
            }`;
            text.textContent = `${count} / ${MAX_QUEUE}`;

            if (q.length === 0) {
                box.innerHTML = "";
                box.appendChild(empty); 
                empty.classList.remove("hidden");
                box.scrollLeft = 0;
                return;
            } else {
                empty.classList.add("hidden");
            }
            
            const colors = ['bg-blue-600', 'bg-green-600', 'bg-yellow-500', 'bg-purple-600', 'bg-pink-600'];
            const fragment = document.createDocumentFragment();

            // 2. X·ª≠ l√Ω animation Exit
            oldItems.forEach(oldItem => {
                const oldIndex = parseInt(oldItem.dataset.index);
                if (newQueue.indexOf(oldIndex) === -1) {
                    oldItem.classList.replace('show', 'exit');
                    oldItem.classList.remove('ring-2', 'ring-white', 'shadow-lg');
                    setTimeout(() => oldItem.remove(), 400);
                }
            });

            // 3. X·ª≠ l√Ω animation Enter/Update
            newQueue.forEach((laneIndex, i) => {
                let itemEl = box.querySelector(`[data-index="${laneIndex}"]`);
                const laneName = laneNamesMap[laneIndex] || `Lo·∫°i ${laneIndex + 1}`;
                const colorClass = colors[laneIndex % colors.length] || 'bg-gray-600';
                const isHead = (i === 0);

                if (!itemEl) {
                    // T·∫°o m·ªõi (ENTER)
                    itemEl = document.createElement("span");
                    itemEl.className = `queue-item ${colorClass} enter`;
                    itemEl.dataset.index = laneIndex;
                    itemEl.textContent = laneName;
                    fragment.appendChild(itemEl);
                    setTimeout(() => itemEl.classList.replace('enter', 'show'), 10);
                } else {
                    // ƒê√£ t·ªìn t·∫°i (UPDATE/MOVE)
                    itemEl.classList.replace('exit', 'show');
                }

                // C·∫≠p nh·∫≠t tr·∫°ng th√°i 'Ti·∫øp theo'
                itemEl.classList.toggle('ring-2', isHead);
                itemEl.classList.toggle('ring-white', isHead);
                itemEl.classList.toggle('shadow-lg', isHead);
                itemEl.innerHTML = isHead ? `‚Üí ${laneName}` : laneName;
                itemEl.style.minWidth = isHead ? '100px' : '80px'; // L√†m n·ªïi b·∫≠t item ƒë·∫ßu

                // T·∫°m th·ªùi lo·∫°i b·ªè n√≥ kh·ªèi container ƒë·ªÉ ch√®n l·∫°i ƒë√∫ng v·ªã tr√≠
                if (itemEl.parentNode === box) {
                    box.removeChild(itemEl);
                }
            });
            
            // 4. Ch√®n l·∫°i c√°c ph·∫ßn t·ª≠ theo ƒë√∫ng th·ª© t·ª± m·ªõi
            newQueue.forEach((laneIndex, i) => {
                const itemEl = box.querySelector(`[data-index="${laneIndex}"]`) || fragment.querySelector(`[data-index="${laneIndex}"]`);
                if (itemEl) {
                    const nextElement = box.children[i];
                    box.insertBefore(itemEl, nextElement);
                }
            });
            
            box.appendChild(fragment); // Ch√®n c√°c ph·∫ßn t·ª≠ m·ªõi

            box.scrollLeft = box.scrollWidth; // Cu·ªôn ƒë·∫øn cu·ªëi
        }

        // --- C·∫≠p nh·∫≠t State ---
        function updateState(s) {
            // X·ª≠ l√Ω Maintenance banner (c·∫ßn l√†m tr∆∞·ªõc khi c·∫≠p nh·∫≠t lane)
            if (s.maintenance_mode) {
                const errorMsg = s.last_error || "L·ªói kh√¥ng x√°c ƒë·ªãnh.";
                document.getElementById('maintenance-error').textContent = errorMsg;
                document.getElementById('maintenance-banner').classList.remove('hidden');
            } else {
                document.getElementById('maintenance-banner').classList.add('hidden');
            }

            s.lanes.forEach((l, i) => {
                // Ch·ªâ render lane n·∫øu n√≥ c√≥ ID t∆∞∆°ng ·ª©ng (lite ch·ªâ c√≥ 0, 1, 2)
                const laneEl = document.getElementById(`lane-${i}`);
                if (!laneEl) return; 

                laneNamesMap[i] = l.name;
                
                document.getElementById(`lane-${i}-name`).textContent = l.name;
                document.getElementById(`lane-${i}-count`).textContent = l.count;
                document.getElementById(`lane-${i}-sensor`).classList.toggle("sensor-active", l.sensor_reading === 0);
                document.getElementById(`lane-${i}-sensor`).classList.toggle("sensor-inactive", l.sensor_reading !== 0);
                document.getElementById(`lane-${i}-grab`).classList.toggle("relay-active", l.relay_grab === 1);
                document.getElementById(`lane-${i}-push`).classList.toggle("relay-active", l.relay_push === 1);

                const statusEl = document.getElementById(`status-text-${i}`);
                statusEl.textContent = l.status;
                const isWaiting = l.status.includes("ƒêang ch·ªù") || l.status.includes("ƒêang ph√¢n lo·∫°i");
                
                statusEl.classList.toggle("bg-blue-500", isWaiting);
                statusEl.classList.toggle("bg-gray-700", !isWaiting);
            });
            
            // Kh√¥ng c·∫ßn c·∫≠p nh·∫≠t gi√° tr·ªã input v√¨ ƒë√£ chuy·ªÉn sang JSON editor
        }

        // --- H√†m T·∫£i v√† L∆∞u C·∫•u h√¨nh ---
        
        async function fetchAPI(url, options = {}) {
            // T·∫°m b·ªè qua logic 401 v√¨ ƒë√¢y l√† b·∫£n Lite kh√¥ng c√≥ logic ƒëƒÉng nh·∫≠p ƒë·∫ßy ƒë·ªß
            try {
                const response = await fetch(url, options);
                if (response.status === 401) {
                    addLog("error", "L·ªói x√°c th·ª±c (401).");
                    throw new Error("Unauthorized");
                }
                if (!response.ok) {
                     const errorData = await response.json().catch(() => ({ error: `L·ªói HTTP: ${response.status}` }));
                     throw new Error(errorData.error || `L·ªói HTTP: ${response.status}`);
                }
                return response;
            } catch (error) {
                // Console log l·ªói chi ti·∫øt cho debug
                console.error("Fetch API error:", error);
                throw error;
            }
        }

        async function loadConfig() {
            try {
                const res = await fetchAPI("/config");
                const cfg = await res.json();
                
                // Hi·ªÉn th·ªã to√†n b·ªô config d∆∞·ªõi d·∫°ng JSON
                document.getElementById("config-json-editor").value = JSON.stringify(cfg, null, 4);

                addLog("success", "ƒê√£ t·∫£i c·∫•u h√¨nh t·ª´ server.");
            } catch (err) {
                addLog("error", `Kh√¥ng th·ªÉ t·∫£i c·∫•u h√¨nh: ${err.message}`);
                document.getElementById("config-json-editor").value = `// L·ªñI: Kh√¥ng th·ªÉ k·∫øt n·ªëi ho·∫∑c ƒë·ªçc file config.\n// Vui l√≤ng ki·ªÉm tra Server Python.\n\n// V√≠ d·ª• c·∫•u tr√∫c:\n{\n  "timing_config": { ... },\n  "lanes_config": [ { ... } ]\n}`;
            }
        }
        
        async function saveConfig() {
            const editor = document.getElementById('config-json-editor');
            let configData;

            try {
                configData = JSON.parse(editor.value);
            } catch (e) {
                addLog('error', 'L·ªói c√∫ ph√°p JSON. Vui l√≤ng ki·ªÉm tra l·∫°i c·∫•u tr√∫c file config.');
                return;
            }

            try {
                // G·ª≠i to√†n b·ªô JSON (bao g·ªìm timing v√† lanes) ƒë·ªÉ c·∫≠p nh·∫≠t
                const res = await fetchAPI("/update_config", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(configData)
                });
                
                const data = await res.json();
                addLog("success", data.message || "ƒê√£ l∆∞u c·∫•u h√¨nh m·ªõi th√†nh c√¥ng.");
                
                if (data.restart_required) {
                    addLog("warn", "C·∫ßn kh·ªüi ƒë·ªông l·∫°i ·ª©ng d·ª•ng ƒë·ªÉ c·∫•u h√¨nh Lanes ho·∫∑c GPIO mode c√≥ hi·ªáu l·ª±c.");
                }
            } catch (err) {
                addLog("error", `Kh√¥ng th·ªÉ l∆∞u config: ${err.message}`);
            }
        }
        
        // --- Ch·ª©c nƒÉng API ---
        async function resetQueue() {
            if (!ws || ws.readyState !== WebSocket.OPEN) return addLog("error", "M·∫•t k·∫øt n·ªëi server.");
            try {
                const res = await fetchAPI("/api/queue/reset", { method: "POST" });
                const data = await res.json();
                addLog("warn", data.message || 'ƒê√£ g·ª≠i y√™u c·∫ßu reset h√†ng ch·ªù.');
            } catch (e) {
                addLog("error", `L·ªói g·ªçi API reset queue: ${e.message}`);
            }
        }

        async function resetMaintenance() {
             if (!ws || ws.readyState !== WebSocket.OPEN) return addLog("error", "M·∫•t k·∫øt n·ªëi server.");
            try {
                const res = await fetchAPI('/api/reset_maintenance', { method: 'POST' });
                const data = await res.json();
                addLog("success", data.message || 'ƒê√£ g·ª≠i y√™u c·∫ßu tho√°t b·∫£o tr√¨.');
            } catch (e) {
                 addLog("error", `L·ªói g·ªçi API reset maintenance: ${e.message}`);
            }
        }

        function resetCount(laneIndex) {
            if (!ws || ws.readyState !== WebSocket.OPEN) return addLog("error", "M·∫•t k·∫øt n·ªëi server.");
            ws.send(JSON.stringify({ action: "reset_count", lane_index: laneIndex }));
            addLog("info", "ƒê√£ g·ª≠i l·ªánh reset ƒë·∫øm.");
        }

        function showQrOverlay(text, bgColorClass) {
            const overlay = document.getElementById("qr-overlay");
            if (!overlay) return;
            if (qrTimer) clearTimeout(qrTimer);
            overlay.textContent = text;
            overlay.className = ``;
            overlay.classList.add('absolute', 'top-4', 'right-4', 'p-2', 'px-4', 'rounded-lg', 'text-xl', 'font-bold', 'text-white', 'opacity-0', 'transition-opacity', 'duration-500', 'shadow-lg');
            overlay.classList.add(...bgColorClass.split(' '));
            setTimeout(() => overlay.style.opacity = '1', 10);
            qrTimer = setTimeout(() => {
                overlay.style.opacity = '0';
            }, 2500);
        }
    </script>
</body>

</html>
