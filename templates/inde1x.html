<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B·∫£ng ƒêi·ªÅu Khi·ªÉn H·ªá Th·ªëng Ph√¢n Lo·∫°i</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .status-card,
        .log-card {
            transition: all 0.3s ease-in-out;
        }

        .status-dot {
            transition: all 0.3s ease-in-out;
        }

        .log-item {
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body class="bg-gray-900 text-white">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-green-400">H·ªá Th·ªëng Ph√¢n Lo·∫°i (Local)</h1>
            <p class="text-gray-400 mt-2">Gi√°m s√°t d√¢y chuy·ªÅn th·ªùi gian th·ª±c</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- C·ªòT TR√ÅI: CAMERA V√Ä LOGS -->
            <div class="flex flex-col gap-8">
                <div class="bg-gray-800 rounded-2xl shadow-lg p-6">
                    <h2 class="text-2xl font-semibold mb-4 border-b-2 border-gray-700 pb-2">üé• Camera Gi√°m S√°t</h2>
                    <div
                        class="aspect-video bg-black rounded-lg overflow-hidden shadow-inner flex items-center justify-center">
                        <img id="camera-feed" src="{{ url_for('video_feed') }}" alt="Camera Feed">
                    </div>
                </div>
                <div class="log-card bg-gray-800 rounded-2xl shadow-lg p-6 flex flex-col" style="height: 40vh;">
                    <h2 class="text-2xl font-semibold mb-4 border-b-2 border-gray-700 pb-2">üì¶ Nh·∫≠t K√Ω H·ªá Th·ªëng</h2>
                    <div id="log-container" class="space-y-3 overflow-y-auto flex-grow pr-2"></div>
                </div>
            </div>
            <!-- C·ªòT PH·∫¢I: TR·∫†NG TH√ÅI -->
            <div class="bg-gray-800 rounded-2xl shadow-lg p-6 flex flex-col">
                <div class="flex items-center justify-between mb-4 border-b-2 border-gray-700 pb-2 flex-shrink-0">
                    <h2 class="text-2xl font-semibold">Tr·∫°ng Th√°i D√¢y Chuy·ªÅn</h2>
                    <span id="connection-status" class="text-sm font-semibold text-yellow-400">‚óè ƒêang k·∫øt n·ªëi...</span>
                </div>
                <div id="lanes-container" class="space-y-4 flex-grow overflow-y-auto pr-2"></div>
            </div>
        </main>
    </div>

    <script>
        const lanesContainer = document.getElementById('lanes-container');
        const connectionStatus = document.getElementById('connection-status');
        const logContainer = document.getElementById('log-container');

        const initialLanes = [{ name: "Lo·∫°i 1", icon: "ü•á" }, { name: "Lo·∫°i 2", icon: "ü•à" }, { name: "Lo·∫°i 3", icon: "ü•â" }];

        function createLaneHTML(lane, index) {
            return `<div id="lane-card-${index}" class="status-card bg-gray-700 rounded-lg p-4 border-l-4 border-gray-500">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-bold">${lane.icon} ${lane.name}</h3>
                            <p id="lane-count-${index}" class="text-xl font-bold text-gray-300">0</p>
                        </div>
                        <div class="flex items-center justify-between mt-1">
                            <p id="lane-status-${index}" class="text-gray-400 text-sm">ƒêang kh·ªüi t·∫°o...</p>
                            <div id="lane-dot-${index}" class="status-dot w-3 h-3 rounded-full bg-gray-500"></div>
                        </div>
                        <div class="grid grid-cols-3 gap-x-2 mt-3 pt-2 border-t border-gray-600 text-xs text-center">
                            <div><p class="font-semibold text-gray-400">C·∫£m Bi·∫øn</p><p id="lane-sensor-${index}" class="font-mono mt-1 text-gray-500">-</p></div>
                            <div><p class="font-semibold text-gray-400">Piston Thu</p><p id="lane-relay-grab-${index}" class="font-mono mt-1 text-gray-500">-</p></div>
                            <div><p class="font-semibold text-gray-400">Piston ƒê·∫©y</p><p id="lane-relay-push-${index}" class="font-mono mt-1 text-gray-500">-</p></div>
                        </div>
                    </div>`;
        }

        function updateFullUI(state) {
            connectionStatus.textContent = "‚óè H·ªá th·ªëng Online";
            connectionStatus.className = "text-sm font-semibold text-green-400";

            state.lanes.forEach((lane, index) => {
                document.getElementById(`lane-count-${index}`).textContent = lane.count;
                document.getElementById(`lane-status-${index}`).textContent = lane.status;
                const card = document.getElementById(`lane-card-${index}`);
                const dot = document.getElementById(`lane-dot-${index}`);
                dot.className = 'status-dot w-3 h-3 rounded-full ';
                switch (lane.status) {
                    case "S·∫µn s√†ng": card.style.borderColor = '#22C55E'; dot.classList.add('bg-green-500'); break;
                    case "ƒêang ch·ªù v·∫≠t...": card.style.borderColor = '#EAB308'; dot.classList.add('bg-yellow-500'); break;
                    case "ƒêang ph√¢n lo·∫°i...": card.style.borderColor = '#3B82F6'; dot.classList.add('bg-blue-500'); break;
                    default: card.style.borderColor = '#6B7280'; dot.classList.add('bg-gray-500'); break;
                }
                const sensorEl = document.getElementById(`lane-sensor-${index}`);
                sensorEl.textContent = lane.sensor === 0 ? "C√ì V·∫¨T" : "Tr·ªëng";
                sensorEl.className = 'font-mono mt-1 ' + (sensorEl.textContent === "C√ì V·∫¨T" ? "font-bold text-yellow-300" : "text-gray-500");
                const grabEl = document.getElementById(`lane-relay-grab-${index}`);
                grabEl.textContent = lane.relay_grab === 1 ? "B·∫¨T" : "T·∫ÆT";
                grabEl.className = 'font-mono mt-1 ' + (grabEl.textContent === "B·∫¨T" ? "font-bold text-green-400" : "text-gray-500");
                const pushEl = document.getElementById(`lane-relay-push-${index}`);
                pushEl.textContent = lane.relay_push === 1 ? "B·∫¨T" : "T·∫ÆT";
                pushEl.className = 'font-mono mt-1 ' + (pushEl.textContent === "B·∫¨T" ? "font-bold text-red-400" : "text-gray-500");
            });
        }

        function addLog(container, message) {
            const logItem = document.createElement('div');
            logItem.className = 'log-item text-sm p-2 rounded-md bg-gray-700/50';
            logItem.innerHTML = message;
            container.prepend(logItem);
            if (container.children.length > 50) container.removeChild(container.lastChild);
        }

        // --- WEBSOCKET CONNECTION ---
        function connectWebSocket() {
            const ws_protocol = window.location.protocol === 'http:' ? 'ws://' : 'wss://';
            const socket = new WebSocket(`${ws_protocol}${window.location.host}/ws`);

            socket.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                if (msg.type === 'state_update') {
                    updateFullUI(msg.state);
                } else if (msg.type === 'log') {
                    const { log_type, timestamp, data, name, count, message } = msg;
                    let logHtml = `<span class="font-mono text-gray-400">${timestamp}</span> | `;
                    if (log_type === 'qr') { logHtml += `Qu√©t m√£: <strong class="text-blue-300">${data}</strong>`; }
                    else if (log_type === 'unknown_qr') { logHtml += `<strong class="text-yellow-400">M√£ kh√¥ng h·ª£p l·ªá:</strong> <strong class="text-yellow-500">${data}</strong>`; }
                    else if (log_type === 'ng_product') { logHtml += `S·∫£n ph·∫©m <strong class="text-gray-400">NG</strong> ƒëi qua.`; }
                    else if (log_type === 'sort') { logHtml += `S·∫£n ph·∫©m <strong>${name}</strong> ƒë√£ ph√¢n lo·∫°i. (T·ªïng: ${count})`; }
                    else { logHtml += `${message}`; }
                    addLog(logContainer, logHtml);
                }
            };
            socket.onopen = () => { connectionStatus.textContent = "‚óè ƒê√£ k·∫øt n·ªëi"; connectionStatus.className = "text-sm text-green-400 font-semibold"; };
            socket.onclose = () => { connectionStatus.textContent = "‚óè M·∫•t k·∫øt n·ªëi. T·∫£i l·∫°i trang..."; connectionStatus.className = "text-sm text-red-400 font-semibold"; };
            socket.onerror = () => { connectionStatus.textContent = "‚óè L·ªói WebSocket."; connectionStatus.className = "text-sm text-red-400 font-semibold"; };
        }

        // --- INITIAL LOAD ---
        document.addEventListener('DOMContentLoaded', () => {
            lanesContainer.innerHTML = initialLanes.map(createLaneHTML).join('');
            connectWebSocket();
        });
    </script>
</body>

</html>
