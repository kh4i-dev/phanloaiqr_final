<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ Thống Phân Loại</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: Inter, sans-serif;
        }

        .sensor-light {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            transition: background-color 0.3s;
        }

        .sensor-active {
            background-color: #f59e0b;
        }

        /* Vàng */
        .sensor-inactive {
            background-color: #6b7280;
        }

        /* Xám */

        .relay-light {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            transition: background-color 0.3s;
        }

        .relay-active {
            background-color: #22c55e;
        }

        /* Xanh */
        .relay-inactive {
            background-color: #ef4444;
        }

        /* Đỏ */
    </style>
</head>

<body class="bg-gray-100 text-gray-900 p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <h1 class="text-3xl font-bold text-center mb-6 text-gray-800">Bảng điều khiển Hệ Thống Phân Loại</h1>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Cột Camera và Logs -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Camera -->
                <div class="bg-white p-4 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-3">Camera Feed</h2>
                    <div class="bg-black rounded-md overflow-hidden aspect-video">
                        <img id="video_feed" src="/video_feed" alt="Video Stream" class="w-full h-full object-contain">
                    </div>
                </div>

                <!-- Logs -->
                <div class="bg-white p-4 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-3">Nhật ký hoạt động</h2>
                    <div id="log-container"
                        class="h-64 bg-gray-900 text-white font-mono text-sm p-3 rounded-md overflow-y-scroll space-y-1">
                        <!-- Logs sẽ được thêm vào đây -->
                    </div>
                </div>
            </div>

            <!-- Cột Trạng thái Lanes -->
            <div class="lg:col-span-1 space-y-6">

                <!-- Trạng thái Lanes -->
                <div class="bg-white p-4 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-3">Trạng thái Lanes</h2>
                    <div id="lanes-container" class="space-y-4">
                        <!-- Lane 1 -->
                        <div id="lane-0" class="border border-gray-200 p-4 rounded-lg">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="text-lg font-bold">Loại 1</h3>
                                <span id="lane-0-status"
                                    class="text-sm font-medium px-3 py-1 rounded-full bg-gray-200 text-gray-800">...</span>
                            </div>
                            <div class="flex justify-between items-center text-lg mb-3">
                                <span>Đã đếm:</span>
                                <span id="lane-0-count" class="font-bold text-2xl">0</span>
                            </div>
                            <div class="flex justify-between items-center text-sm">
                                <span>Cảm biến:</span>
                                <div id="lane-0-sensor" class="sensor-light sensor-inactive"></div>
                            </div>
                            <div class="flex justify-between items-center text-sm mt-2">
                                <span>Relay Thu:</span>
                                <div id="lane-0-grab" class="relay-light relay-inactive"></div>
                            </div>
                            <div class="flex justify-between items-center text-sm mt-2">
                                <span>Relay Đẩy:</span>
                                <div id="lane-0-push" class="relay-light relay-inactive"></div>
                            </div>
                            <button onclick="resetCount(0)"
                                class="mt-3 w-full text-sm bg-yellow-500 hover:bg-yellow-600 text-white py-1 px-3 rounded">Reset
                                Đếm</button>
                        </div>

                        <!-- Lane 2 -->
                        <div id="lane-1" class="border border-gray-200 p-4 rounded-lg">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="text-lg font-bold">Loại 2</h3>
                                <span id="lane-1-status"
                                    class="text-sm font-medium px-3 py-1 rounded-full bg-gray-200 text-gray-800">...</span>
                            </div>
                            <div class="flex justify-between items-center text-lg mb-3">
                                <span>Đã đếm:</span>
                                <span id="lane-1-count" class="font-bold text-2xl">0</span>
                            </div>
                            <div class="flex justify-between items-center text-sm">
                                <span>Cảm biến:</span>
                                <div id="lane-1-sensor" class="sensor-light sensor-inactive"></div>
                            </div>
                            <div class="flex justify-between items-center text-sm mt-2">
                                <span>Relay Thu:</span>
                                <div id="lane-1-grab" class="relay-light relay-inactive"></div>
                            </div>
                            <div class="flex justify-between items-center text-sm mt-2">
                                <span>Relay Đẩy:</span>
                                <div id="lane-1-push" class="relay-light relay-inactive"></div>
                            </div>
                            <button onclick="resetCount(1)"
                                class="mt-3 w-full text-sm bg-yellow-500 hover:bg-yellow-600 text-white py-1 px-3 rounded">Reset
                                Đếm</button>
                        </div>

                        <!-- Lane 3 -->
                        <div id="lane-2" class="border border-gray-200 p-4 rounded-lg">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="text-lg font-bold">Loại 3</h3>
                                <span id="lane-2-status"
                                    class="text-sm font-medium px-3 py-1 rounded-full bg-gray-200 text-gray-800">...</span>
                            </div>
                            <div class="flex justify-between items-center text-lg mb-3">
                                <span>Đã đếm:</span>
                                <span id="lane-2-count" class="font-bold text-2xl">0</span>
                            </div>
                            <div class="flex justify-between items-center text-sm">
                                <span>Cảm biến:</span>
                                <div id="lane-2-sensor" class="sensor-light sensor-inactive"></div>
                            </div>
                            <div class="flex justify-between items-center text-sm mt-2">
                                <span>Relay Thu:</span>
                                <div id="lane-2-grab" class="relay-light relay-inactive"></div>
                            </div>
                            <div class="flex justify-between items-center text-sm mt-2">
                                <span>Relay Đẩy:</span>
                                <div id="lane-2-push" class="relay-light relay-inactive"></div>
                            </div>
                            <button onclick="resetCount(2)"
                                class="mt-3 w-full text-sm bg-yellow-500 hover:bg-yellow-600 text-white py-1 px-3 rounded">Reset
                                Đếm</button>
                        </div>
                    </div>
                    <button onclick="resetCount('all')"
                        class="mt-4 w-full bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded font-bold">Reset
                        Toàn Bộ</button>
                </div>

            </div>
        </div>
    </div>

    <script>
        let ws;

        function connectWebSocket() {
            const ws_protocol = window.location.protocol === "https:" ? "wss://" : "ws://";
            ws = new WebSocket(ws_protocol + window.location.host + "/ws");

            ws.onopen = () => {
                addLog("info", "Đã kết nối với server.");
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type === "state_update") {
                    updateState(data.state);
                } else if (data.type === "log") {
                    addLog(data.log_type, data.message || `[${data.name || data.data}]`, data.timestamp);
                }
            };

            ws.onclose = () => {
                addLog("error", "Mất kết nối. Đang thử kết nối lại sau 3s...");
                setTimeout(connectWebSocket, 3000);
            };

            ws.onerror = (err) => {
                addLog("error", "Lỗi WebSocket.");
                ws.close();
            };
        }

        function updateState(state) {
            state.lanes.forEach((lane, i) => {
                const statusEl = document.getElementById(`lane-${i}-status`);
                const countEl = document.getElementById(`lane-${i}-count`);
                const sensorEl = document.getElementById(`lane-${i}-sensor`);
                const grabEl = document.getElementById(`lane-${i}-grab`);
                const pushEl = document.getElementById(`lane-${i}-push`);

                // Cập nhật status
                statusEl.textContent = lane.status;
                statusEl.className = "text-sm font-medium px-3 py-1 rounded-full ";
                switch (lane.status) {
                    case "Sẵn sàng":
                        statusEl.classList.add("bg-green-100", "text-green-800");
                        break;
                    case "Đang chờ vật...":
                        statusEl.classList.add("bg-yellow-100", "text-yellow-800");
                        break;
                    case "Đang phân loại...":
                        statusEl.classList.add("bg-blue-100", "text-blue-800");
                        break;
                    default:
                        statusEl.classList.add("bg-gray-200", "text-gray-800");
                }

                // Cập nhật count
                countEl.textContent = lane.count;

                // Cập nhật sensor (0 = active, 1 = inactive)
                sensorEl.classList.toggle("sensor-active", lane.sensor_reading === 0);
                sensorEl.classList.toggle("sensor-inactive", lane.sensor_reading !== 0);

                // Cập nhật relays (1 = active, 0 = inactive)
                grabEl.classList.toggle("relay-active", lane.relay_grab === 1);
                grabEl.classList.toggle("relay-inactive", lane.relay_grab !== 1);

                pushEl.classList.toggle("relay-active", lane.relay_push === 1);
                pushEl.classList.toggle("relay-inactive", lane.relay_push !== 1);
            });
        }

        function addLog(type, message, timestamp) {
            if (!timestamp) {
                timestamp = new Date().toLocaleTimeString('vi-VN');
            }
            const logContainer = document.getElementById("log-container");
            const p = document.createElement("p");
            let color = "text-gray-300";
            let prefix = "[INFO]";

            switch (type) {
                case "error": color = "text-red-400"; prefix = "[ERROR]"; break;
                case "warn": color = "text-yellow-400"; prefix = "[WARN]"; break;
                case "qr": color = "text-cyan-400"; prefix = `[QR: ${message}]`; message = ""; break;
                case "sort": color = "text-green-400"; prefix = `[SORT: ${message}]`; message = ""; break;
            }

            p.className = color;
            p.innerHTML = `<span class="text-gray-500">${timestamp}</span> ${prefix} ${message}`;
            logContainer.appendChild(p);
            logContainer.scrollTop = logContainer.scrollHeight; // Cuộn xuống dưới
        }

        function resetCount(lane) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ action: "reset_count", lane: lane }));
            } else {
                addLog("error", "Không thể reset: Mất kết nối server.");
            }
        }

        // Bắt đầu kết nối
        document.addEventListener("DOMContentLoaded", connectWebSocket);
    </script>
</body>

</html>