<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>B·∫£ng ƒêi·ªÅu Khi·ªÉn H·ªá Th·ªëng Ph√¢n Lo·∫°i (Local)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .status-card, .log-card { transition: all 0.25s ease-in-out; }
    .log-item { animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-5px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>

<body class="bg-gray-900 text-white">

  <div class="container mx-auto p-4 md:p-6">
    <header class="text-center mb-6">
      <h1 class="text-3xl md:text-4xl font-bold text-green-400">‚öôÔ∏è H·ªá Th·ªëng Ph√¢n Lo·∫°i S·∫£n Ph·∫©m (Local)</h1>
      <p class="text-gray-400 mt-1">Gi√°m s√°t v√† ƒëi·ªÅu khi·ªÉn th·ªùi gian th·ª±c</p>
    </header>

    <main class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- C·ªòT TR√ÅI: CAMERA + LOG -->
      <div class="flex flex-col gap-6">
        <section class="bg-gray-800 rounded-2xl shadow-lg p-5">
          <h2 class="text-2xl font-semibold mb-3 border-b border-gray-700 pb-2">üé• Camera Gi√°m S√°t</h2>
          <div class="aspect-video bg-black rounded-lg overflow-hidden flex items-center justify-center">
            <img id="camera-feed" src="{{ url_for('video_feed') }}" alt="Camera Feed" class="w-full h-full object-cover">
          </div>
        </section>

        <section class="log-card bg-gray-800 rounded-2xl shadow-lg p-5 flex flex-col" style="height: 40vh;">
          <h2 class="text-2xl font-semibold mb-3 border-b border-gray-700 pb-2">üìú Nh·∫≠t K√Ω H·ªá Th·ªëng</h2>
          <div id="log-container" class="space-y-2 overflow-y-auto flex-grow pr-2"></div>
        </section>
      </div>

      <!-- C·ªòT PH·∫¢I: TR·∫†NG TH√ÅI -->
      <section class="bg-gray-800 rounded-2xl shadow-lg p-5 flex flex-col">
        <div class="flex items-center justify-between mb-3 border-b border-gray-700 pb-2">
          <h2 class="text-2xl font-semibold">Tr·∫°ng Th√°i D√¢y Chuy·ªÅn</h2>
          <span id="connection-status" class="text-sm font-semibold text-yellow-400">‚óè ƒêang k·∫øt n·ªëi...</span>
        </div>
        <div id="lanes-container" class="space-y-4 overflow-y-auto flex-grow pr-2"></div>
      </section>
    </main>
  </div>

  <script>
    const lanesContainer = document.getElementById("lanes-container");
    const connectionStatus = document.getElementById("connection-status");
    const logContainer = document.getElementById("log-container");

    const initialLanes = [
      { name: "Lo·∫°i 1", icon: "ü•á" },
      { name: "Lo·∫°i 2", icon: "ü•à" },
      { name: "Lo·∫°i 3", icon: "ü•â" },
    ];

    // === T·∫†O UI BAN ƒê·∫¶U ===
    function createLaneHTML(lane, index) {
      return `
        <div id="lane-card-${index}" class="status-card bg-gray-700 rounded-lg p-4 border-l-4 border-gray-600">
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-bold">${lane.icon} ${lane.name}</h3>
            <p id="lane-count-${index}" class="text-xl font-bold text-gray-300">0</p>
          </div>
          <div class="flex items-center justify-between mt-1">
            <p id="lane-status-${index}" class="text-gray-400 text-sm">ƒêang kh·ªüi t·∫°o...</p>
            <div id="lane-dot-${index}" class="w-3 h-3 rounded-full bg-gray-500"></div>
          </div>
          <div class="grid grid-cols-3 gap-x-2 mt-3 pt-2 border-t border-gray-600 text-xs text-center">
            <div><p class="font-semibold text-gray-400">C·∫£m Bi·∫øn</p><p id="lane-sensor-${index}" class="font-mono mt-1 text-gray-500">-</p></div>
            <div><p class="font-semibold text-gray-400">Piston Thu</p><p id="lane-relay-grab-${index}" class="font-mono mt-1 text-gray-500">-</p></div>
            <div><p class="font-semibold text-gray-400">Piston ƒê·∫©y</p><p id="lane-relay-push-${index}" class="font-mono mt-1 text-gray-500">-</p></div>
          </div>
        </div>`;
    }

    lanesContainer.innerHTML = initialLanes.map(createLaneHTML).join("");

    // === C·∫¨P NH·∫¨T TR·∫†NG TH√ÅI LANE ===
    function updateFullUI(state) {
      connectionStatus.textContent = "‚óè H·ªá th·ªëng Online";
      connectionStatus.className = "text-sm font-semibold text-green-400";
      window.requestAnimationFrame(() => {
        state.lanes.forEach((lane, index) => {
          const countEl = document.getElementById(`lane-count-${index}`);
          const statusEl = document.getElementById(`lane-status-${index}`);
          const dotEl = document.getElementById(`lane-dot-${index}`);
          const card = document.getElementById(`lane-card-${index}`);

          if (!countEl) return;

          countEl.textContent = lane.count;
          statusEl.textContent = lane.status;
          dotEl.className = "w-3 h-3 rounded-full transition";
          card.style.borderColor = "#6B7280";

          switch (lane.status) {
            case "S·∫µn s√†ng": dotEl.classList.add("bg-green-500"); card.style.borderColor = "#22C55E"; break;
            case "ƒêang ch·ªù v·∫≠t...": dotEl.classList.add("bg-yellow-500"); card.style.borderColor = "#EAB308"; break;
            case "ƒêang ph√¢n lo·∫°i...": dotEl.classList.add("bg-blue-500"); card.style.borderColor = "#3B82F6"; break;
            default: dotEl.classList.add("bg-gray-500"); break;
          }

          const s = document.getElementById(`lane-sensor-${index}`);
          const g = document.getElementById(`lane-relay-grab-${index}`);
          const p = document.getElementById(`lane-relay-push-${index}`);

          s.textContent = lane.sensor === 0 ? "C√ì V·∫¨T" : "Tr·ªëng";
          s.className = "font-mono mt-1 " + (lane.sensor === 0 ? "font-bold text-yellow-300" : "text-gray-500");
          g.textContent = lane.relay_grab === 1 ? "B·∫¨T" : "T·∫ÆT";
          g.className = "font-mono mt-1 " + (lane.relay_grab === 1 ? "font-bold text-green-400" : "text-gray-500");
          p.textContent = lane.relay_push === 1 ? "B·∫¨T" : "T·∫ÆT";
          p.className = "font-mono mt-1 " + (lane.relay_push === 1 ? "font-bold text-red-400" : "text-gray-500");
        });
      });
    }

    // === TH√äM LOG ===
    function addLog(message) {
      const logItem = document.createElement("div");
      logItem.className = "log-item text-sm p-2 rounded-md bg-gray-700/50";
      logItem.innerHTML = message;
      logContainer.prepend(logItem);
      if (logContainer.children.length > 60) logContainer.removeChild(logContainer.lastChild);
    }

    // === K·∫æT N·ªêI WEBSOCKET ===
    function connectWebSocket() {
      const ws_protocol = window.location.protocol === "http:" ? "ws://" : "wss://";
      const socket = new WebSocket(`${ws_protocol}${window.location.host}/ws`);

      socket.onopen = () => {
        connectionStatus.textContent = "‚óè ƒê√£ k·∫øt n·ªëi";
        connectionStatus.className = "text-sm text-green-400 font-semibold";
      };

      socket.onmessage = (event) => {
        const msg = JSON.parse(event.data);
        if (msg.type === "state_update") {
          updateFullUI(msg.state);
        } else if (msg.type === "log") {
          const { log_type, timestamp, data, name, count, message } = msg;
          let logHtml = `<span class="font-mono text-gray-400">${timestamp}</span> | `;
          if (log_type === "qr") logHtml += `Qu√©t m√£: <strong class="text-blue-300">${data}</strong>`;
          else if (log_type === "sensor") logHtml += `C·∫£m bi·∫øn <strong>${name}</strong>: ${msg.status === 0 ? '<span class="text-yellow-300">C√ì V·∫¨T</span>' : '<span class="text-gray-500">Tr·ªëng</span>'}`;
          else if (log_type === "sort") logHtml += `S·∫£n ph·∫©m <strong>${name}</strong> ƒë√£ ph√¢n lo·∫°i. (T·ªïng: ${count})`;
          else if (log_type === "qr_ng") logHtml += `M√£ <strong class="text-yellow-400">NG</strong> ‚Äì Cho qua.`;
          else logHtml += message || "";
          addLog(logHtml);
        }
      };

      socket.onclose = () => {
        connectionStatus.textContent = "‚óè M·∫•t k·∫øt n·ªëi ‚Äì th·ª≠ l·∫°i...";
        connectionStatus.className = "text-sm text-red-400 font-semibold";
        setTimeout(connectWebSocket, 3000);
      };

      socket.onerror = () => {
        connectionStatus.textContent = "‚óè L·ªói WebSocket";
        connectionStatus.className = "text-sm text-red-400 font-semibold";
      };
    }

    document.addEventListener("DOMContentLoaded", connectWebSocket);
  </script>
</body>
</html>
