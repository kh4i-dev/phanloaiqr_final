<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>B·∫£ng ƒêi·ªÅu Khi·ªÉn Ph√¢n Lo·∫°i - V6 (Lite)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: #0f172a;
            color: #e2e8f0;
        }

        .input {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 0.5rem;
            padding: 0.55rem 0.75rem;
            color: inherit;
            transition: border-color .2s, box-shadow .2s;
        }

        .input:focus {
            outline: none;
            border-color: #38bdf8;
            box-shadow: 0 0 0 2px rgba(56, 189, 248, .25);
        }

        .nav-button.active {
            background-color: #2563eb;
            color: #fff;
        }

        .sensor-dot,
        .relay-dot {
            width: 12px;
            height: 12px;
            border-radius: 9999px;
            display: inline-block;
        }

        .sensor-dot.active {
            background: #facc15;
        }

        .sensor-dot.inactive {
            background: #4b5563;
        }

        .relay-dot.on {
            background: #22c55e;
        }

        .relay-dot.off {
            background: #ef4444;
        }

        #logs {
            max-height: 320px;
        }

        #stats-table tbody tr:nth-child(even) {
            background: rgba(255, 255, 255, .03);
        }
    </style>
</head>

<body class="min-h-screen">
    <div class="flex flex-col md:flex-row min-h-screen">
        <aside class="md:w-64 bg-slate-900 border-r border-slate-800">
            <div class="p-5 border-b border-slate-800">
                <h1 class="text-xl font-semibold">H·ªá th·ªëng Ph√¢n lo·∫°i</h1>
                <p class="text-sm text-slate-400">Phi√™n b·∫£n 6 ‚Äî Lite Dashboard</p>
            </div>
            <nav class="p-4 space-y-2" id="nav">
                <button data-page="overview" class="nav-button active w-full px-4 py-2 rounded-lg text-left">üè† T·ªïng
                    quan</button>
                <button data-page="config" class="nav-button w-full px-4 py-2 rounded-lg text-left">‚öôÔ∏è C·∫•u h√¨nh</button>
                <button data-page="stats" class="nav-button w-full px-4 py-2 rounded-lg text-left">üìä Th·ªëng k√™</button>
            </nav>
            <div class="p-4 text-xs text-slate-500 border-t border-slate-800">
                <p>&copy; 2025 QR Sorting System</p>
            </div>
        </aside>

        <main class="flex-1 p-6 space-y-6">
            <!-- OVERVIEW -->
            <section id="page-overview" class="space-y-6">
                <div class="grid gap-6 lg:grid-cols-3">
                    <div class="lg:col-span-2 space-y-6">
                        <div class="bg-slate-900 border border-slate-800 rounded-xl overflow-hidden">
                            <div class="flex items-center justify-between px-4 py-3 border-b border-slate-800">
                                <h2 class="font-semibold text-lg">Camera</h2>
                                <span id="camera-status" class="text-xs uppercase tracking-wider text-slate-400">ƒêang
                                    t·∫£i...</span>
                            </div>
                            <img id="camera-stream" src="/video_feed" alt="Camera"
                                class="w-full aspect-video object-cover bg-slate-950" />
                        </div>

                        <div class="bg-slate-900 border border-slate-800 rounded-xl">
                            <div class="flex items-center justify-between px-4 py-3 border-b border-slate-800">
                                <h2 class="font-semibold text-lg">Nh·∫≠t k√Ω</h2>
                                <button id="btn-clear-logs" class="text-sm text-slate-400 hover:text-white">X√≥a</button>
                            </div>
                            <div id="logs" class="overflow-auto px-4 py-3 space-y-2 text-sm"></div>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <div class="bg-slate-900 border border-slate-800 rounded-xl p-4">
                            <div class="flex items-center justify-between mb-3">
                                <h2 class="font-semibold text-lg">Tr·∫°ng th√°i lanes</h2>
                                <button id="btn-reset-counts"
                                    class="text-sm px-3 py-1 bg-slate-700 hover:bg-slate-600 rounded">Reset ƒë·∫øm</button>
                            </div>
                            <div id="lanes" class="space-y-3"></div>
                        </div>

                        <div class="bg-slate-900 border border-slate-800 rounded-xl p-4 space-y-3">
                            <h2 class="font-semibold text-lg">H√†nh ƒë·ªông nhanh</h2>
                            <div class="space-y-2">
                                <button id="btn-toggle-auto-test"
                                    class="w-full px-3 py-2 rounded bg-slate-800 hover:bg-slate-700">B·∫≠t
                                    Auto-test</button>
                                <div class="text-sm">
                                    <span class="text-slate-400">Auto-test:</span>
                                    <span id="auto-test-status" class="font-semibold">ƒêang t·∫Øt</span>
                                </div>
                                <button id="btn-refresh-state"
                                    class="w-full px-3 py-2 rounded bg-slate-800 hover:bg-slate-700">L√†m m·ªõi tr·∫°ng
                                    th√°i</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- CONFIG -->
            <section id="page-config" class="hidden space-y-4">
                <div class="bg-slate-900 border border-slate-800 rounded-xl p-4 space-y-4">
                    <h2 class="font-semibold text-lg">C·∫•u h√¨nh th·ªùi gian</h2>
                    <form id="timing-form" class="grid gap-4 md:grid-cols-2">
                        <label class="flex flex-col gap-2 text-sm">
                            <span>Cycle delay (s)</span>
                            <input type="number" step="0.01" min="0" name="cycle_delay" class="input" required />
                        </label>
                        <label class="flex flex-col gap-2 text-sm">
                            <span>Settle delay (s)</span>
                            <input type="number" step="0.01" min="0" name="settle_delay" class="input" required />
                        </label>
                        <label class="flex flex-col gap-2 text-sm">
                            <span>Sensor debounce (s)</span>
                            <input type="number" step="0.01" min="0" name="sensor_debounce" class="input" required />
                        </label>
                        <label class="flex flex-col gap-2 text-sm">
                            <span>Push delay (s)</span>
                            <input type="number" step="0.01" min="0" name="push_delay" class="input" required />
                        </label>
                        <label class="flex flex-col gap-2 text-sm">
                            <span>GPIO mode</span>
                            <select name="gpio_mode" class="input" required>
                                <option value="BCM">BCM</option>
                                <option value="BOARD">BOARD</option>
                            </select>
                        </label>
                    </form>
                    <button id="btn-save-config" class="px-4 py-2 bg-blue-500 hover:bg-blue-400 text-white rounded">L∆∞u
                        c·∫•u h√¨nh</button>
                </div>

                <div class="bg-slate-900 border border-slate-800 rounded-xl p-4 space-y-4">
                    <div class="flex items-center justify-between">
                        <h2 class="font-semibold text-lg">Lanes</h2>
                        <button id="btn-add-lane" class="px-3 py-1 text-sm bg-slate-800 rounded">Th√™m lane</button>
                    </div>
                    <div id="lane-config" class="space-y-4"></div>
                </div>
            </section>

            <!-- STATS -->
            <section id="page-stats" class="hidden space-y-4">
                <div class="bg-slate-900 border border-slate-800 rounded-xl p-4 space-y-4">
                    <div class="flex items-center justify-between">
                        <h2 class="font-semibold text-lg">S·∫£n l∆∞·ª£ng theo ng√†y</h2>
                        <button id="btn-refresh-stats" class="px-3 py-1 text-sm bg-slate-800 rounded">L√†m m·ªõi</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table id="stats-table" class="min-w-full text-sm">
                            <thead class="bg-slate-800 uppercase tracking-wide text-xs text-slate-300">
                                <tr>
                                    <th class="px-3 py-2 text-left">Ng√†y</th>
                                    <th class="px-3 py-2 text-left">Lane</th>
                                    <th class="px-3 py-2 text-right">S·ªë l∆∞·ª£ng</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Templates -->
    <template id="lane-template">
        <div class="p-3 border border-slate-800 rounded-lg bg-slate-900/70">
            <div class="flex items-center justify-between mb-2">
                <h3 class="font-semibold text-lg lane-name"></h3>
                <span class="text-xs text-slate-400">Pin c·∫£m bi·∫øn: <span class="lane-sensor"></span></span>
            </div>
            <p class="text-sm text-slate-300 mb-2">Tr·∫°ng th√°i: <span class="lane-status font-medium"></span></p>
            <div class="flex items-center gap-3 text-sm">
                <span>ƒê·∫øm: <span class="lane-count font-semibold"></span></span>
                <span>C·∫£m bi·∫øn: <span class="sensor-dot"></span></span>
                <span>Thu: <span class="relay-dot relay-grab"></span></span>
                <span>ƒê·∫©y: <span class="relay-dot relay-push"></span></span>
            </div>
        </div>
    </template>

    <template id="lane-config-template">
        <div class="p-4 border border-slate-800 rounded-lg bg-slate-900/60 space-y-3" data-index="">
            <div class="flex items-center justify-between">
                <h3 class="font-semibold">Lane <span class="cfg-index"></span></h3>
                <button class="btn-remove-lane text-sm text-red-400">X√≥a</button>
            </div>
            <div class="grid gap-4 md:grid-cols-2">
                <label class="flex flex-col gap-1 text-sm">
                    <span>T√™n</span>
                    <input type="text" class="input cfg-name" required />
                </label>
                <label class="flex flex-col gap-1 text-sm">
                    <span>Sensor pin</span>
                    <input type="number" class="input cfg-sensor" />
                </label>
                <label class="flex flex-col gap-1 text-sm">
                    <span>Push pin</span>
                    <input type="number" class="input cfg-push" />
                </label>
                <label class="flex flex-col gap-1 text-sm">
                    <span>Pull pin</span>
                    <input type="number" class="input cfg-pull" />
                </label>
            </div>
        </div>
    </template>

    <script>
        const pages = ['overview', 'config', 'stats'];
        const state = { autoTest: false };

        // Nav
        document.querySelectorAll('#nav .nav-button').forEach(btn => {
            btn.addEventListener('click', () => switchPage(btn.dataset.page));
        });
        function switchPage(page) {
            pages.forEach(name => {
                document.getElementById(`page-${name}`).classList.toggle('hidden', name !== page);
                document.querySelector(`#nav .nav-button[data-page="${name}"]`).classList.toggle('active', name === page);
            });
        }

        // Elements
        const laneTemplate = document.getElementById('lane-template');
        const lanesContainer = document.getElementById('lanes');
        const logsContainer = document.getElementById('logs');
        const laneConfigTemplate = document.getElementById('lane-config-template');
        const laneConfigContainer = document.getElementById('lane-config');

        // Buttons
        document.getElementById('btn-reset-counts').addEventListener('click', async () => {
            await fetchJSON('/api/reset_counts', { method: 'POST' });
        });
        document.getElementById('btn-refresh-state').addEventListener('click', async () => {
            const data = await fetchJSON('/api/state');
            if (data) renderState(data);
        });
        document.getElementById('btn-clear-logs').addEventListener('click', () => {
            logsContainer.innerHTML = '';
        });
        document.getElementById('btn-save-config').addEventListener('click', saveConfig);
        document.getElementById('btn-add-lane').addEventListener('click', () => addLaneConfig());
        document.getElementById('btn-refresh-stats').addEventListener('click', loadStats);
        document.getElementById('btn-toggle-auto-test').addEventListener('click', () => setAutoTest(!state.autoTest));

        // Helpers
        async function fetchJSON(url, options = {}) {
            try {
                const res = await fetch(url, { headers: { 'Content-Type': 'application/json' }, ...options });
                if (!res.ok) throw new Error(await res.text());
                if (res.status === 204) return null;
                return await res.json();
            } catch (error) {
                console.error(error);
                alert(error.message || error);
            }
        }

        // Renderers
        function renderState(newState) {
            state.autoTest = Boolean(newState.auto_test);

            document.getElementById('camera-status').textContent = 'Ho·∫°t ƒë·ªông';
            document.getElementById('btn-toggle-auto-test').textContent = state.autoTest ? 'T·∫Øt Auto-test' : 'B·∫≠t Auto-test';
            document.getElementById('auto-test-status').textContent = state.autoTest ? 'ƒêang ch·∫°y' : 'ƒêang t·∫Øt';

            lanesContainer.innerHTML = '';
            (newState.lanes || []).forEach(lane => {
                const node = laneTemplate.content.firstElementChild.cloneNode(true);
                node.querySelector('.lane-name').textContent = lane.name ?? 'Lane';
                node.querySelector('.lane-sensor').textContent = lane.sensor_pin ?? '‚Äî';
                node.querySelector('.lane-status').textContent = lane.status ?? '';
                node.querySelector('.lane-count').textContent = lane.count ?? 0;

                const sdot = node.querySelector('.sensor-dot');
                sdot.classList.toggle('active', lane.sensor_reading === 1);
                sdot.classList.toggle('inactive', lane.sensor_reading !== 1);

                const gdot = node.querySelector('.relay-grab');
                gdot.classList.toggle('on', lane.relay_grab === 1);
                gdot.classList.toggle('off', lane.relay_grab !== 1);

                const pdot = node.querySelector('.relay-push');
                pdot.classList.toggle('on', lane.relay_push === 1);
                pdot.classList.toggle('off', lane.relay_push !== 1);

                lanesContainer.appendChild(node);
            });
        }

        function appendLog(entry) {
            const div = document.createElement('div');
            div.className = 'bg-slate-800/60 border border-slate-700 px-3 py-2 rounded';
            div.innerHTML = `<span class="text-xs text-slate-400 mr-2">${entry.timestamp}</span>${entry.message}`;
            logsContainer.prepend(div);
            while (logsContainer.childElementCount > 80) logsContainer.removeChild(logsContainer.lastElementChild);
        }

        function renderConfig(config) {
            const form = document.getElementById('timing-form');
            form.cycle_delay.value = config.timing_config.cycle_delay;
            form.settle_delay.value = config.timing_config.settle_delay;
            form.sensor_debounce.value = config.timing_config.sensor_debounce;
            form.push_delay.value = config.timing_config.push_delay;
            form.gpio_mode.value = config.timing_config.gpio_mode;

            laneConfigContainer.innerHTML = '';
            (config.lanes_config || []).forEach((lane, index) => addLaneConfig(lane, index));
        }

        function addLaneConfig(lane = { name: '', sensor_pin: '', push_pin: '', pull_pin: '' }, index = null) {
            const node = laneConfigTemplate.content.firstElementChild.cloneNode(true);
            const idx = index ?? laneConfigContainer.childElementCount;
            node.dataset.index = idx;
            node.querySelector('.cfg-index').textContent = idx + 1;
            node.querySelector('.cfg-name').value = lane.name || '';
            node.querySelector('.cfg-sensor').value = lane.sensor_pin ?? '';
            node.querySelector('.cfg-push').value = lane.push_pin ?? '';
            node.querySelector('.cfg-pull').value = lane.pull_pin ?? '';
            node.querySelector('.btn-remove-lane').addEventListener('click', () => node.remove());
            laneConfigContainer.appendChild(node);
        }

        async function saveConfig() {
            const form = document.getElementById('timing-form');
            const payload = {
                timing_config: {
                    cycle_delay: parseFloat(form.cycle_delay.value),
                    settle_delay: parseFloat(form.settle_delay.value),
                    sensor_debounce: parseFloat(form.sensor_debounce.value),
                    push_delay: parseFloat(form.push_delay.value),
                    gpio_mode: form.gpio_mode.value
                },
                lanes_config: Array.from(laneConfigContainer.children).map(node => ({
                    name: node.querySelector('.cfg-name').value || 'Lane',
                    sensor_pin: node.querySelector('.cfg-sensor').value ? parseInt(node.querySelector('.cfg-sensor').value, 10) : null,
                    push_pin: node.querySelector('.cfg-push').value ? parseInt(node.querySelector('.cfg-push').value, 10) : null,
                    pull_pin: node.querySelector('.cfg-pull').value ? parseInt(node.querySelector('.cfg-pull').value, 10) : null,
                }))
            };
            await fetchJSON('/api/config', { method: 'POST', body: JSON.stringify(payload) });
        }

        async function loadConfig() {
            const config = await fetchJSON('/api/config');
            if (config) renderConfig(config);
        }

        async function loadStats() {
            const stats = await fetchJSON('/api/stats');
            const tbody = document.querySelector('#stats-table tbody');
            tbody.innerHTML = '';
            if (!stats) return;
            Object.entries(stats).forEach(([day, lanes]) => {
                Object.entries(lanes).forEach(([lane, count]) => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
            <td class="px-3 py-2">${day}</td>
            <td class="px-3 py-2">${lane}</td>
            <td class="px-3 py-2 text-right font-semibold">${count}</td>
          `;
                    tbody.appendChild(tr);
                });
            });
        }

        async function setAutoTest(enabled) {
            const res = await fetchJSON('/api/auto_test', {
                method: 'POST', body: JSON.stringify({ enabled })
            });
            if (res) {
                state.autoTest = res.enabled;
                document.getElementById('auto-test-status').textContent = state.autoTest ? 'ƒêang ch·∫°y' : 'ƒêang t·∫Øt';
                document.getElementById('btn-toggle-auto-test').textContent = state.autoTest ? 'T·∫Øt Auto-test' : 'B·∫≠t Auto-test';
            }
        }

        // WS
        function setupWebSocket() {
            const protocol = location.protocol === 'https:' ? 'wss' : 'ws';
            const ws = new WebSocket(`${protocol}://${location.host}/ws`);
            ws.addEventListener('message', event => {
                const payload = JSON.parse(event.data);
                if (payload.type === 'state') renderState(payload.state);
                else if (payload.type === 'log') appendLog(payload);
            });
            ws.addEventListener('close', () => { setTimeout(setupWebSocket, 2000); });
        }

        // Init
        (async function init() {
            setupWebSocket();
            const initState = await fetchJSON('/api/state');
            if (initState) renderState(initState);
            await loadConfig();
            await loadStats();
        })();
    </script>
</body>

</html>